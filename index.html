<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>èŠ±ç“£è­˜å­—æŸ¥å­—å™¨ï¼ˆå«éƒ¨é¦–åœˆï¼‰</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Iansui&display=swap" rel="stylesheet">
  <style>
    body{font-family:"Iansui","DFKai-SB","BiauKai","KaiTi","æ¨™æ¥·é«”",serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
    .btn-selected{background:#fb923c;color:#fff;border-color:#f97316}
    .page-hidden{display:none}
    #petal-container{transition:min-height .3s ease}
    .petal-char-container,.center-char-container{transform:translateZ(0)}
    .zhuyin-col{display:flex;flex-direction:column;justify-content:center;align-items:center;line-height:1;margin-left:2px}
    .radical-dot{
      position:absolute; display:flex; align-items:center; justify-content:center;
      width:2.25rem; height:2.25rem; border-radius:9999px;
      background:#f1f5f9; border:2px solid #cbd5e1; font-weight:600;
      transition:transform .15s ease, background .15s ease, border-color .15s ease;
      box-shadow:0 2px 6px rgba(0,0,0,.06);
    }
    .radical-dot:hover{ transform:scale(1.08); background:#fee2e2; border-color:#fecaca }
    .center-radical-badge{
      position:absolute; bottom:-10px; left:50%; transform:translateX(-50%);
      background:#fff; border:2px solid #fde68a; color:#b45309;
      padding:.1rem .4rem; border-radius:9999px; font-weight:700; font-size:.9rem;
      box-shadow:0 2px 6px rgba(0,0,0,.06);
    }
  </style>
</head>
<body class="bg-sky-50 text-gray-800">
  <div class="container mx-auto p-4 md:p-8">
    <div id="selection-page">
      <header class="text-center mb-8">
        <h1 class="text-4xl font-bold text-cyan-600 mb-2">èŠ±ç“£è­˜å­—æŸ¥å­—å™¨</h1>
        <p class="text-lg text-gray-600">è«‹å…ˆé¸æ“‡æ³¨éŸ³ï¼Œå†é»æ“Šéƒ¨ä»¶ä¾†è­˜å­—ã€‚æ”¯æ´å…¨æ–‡æª¢ç´¢ & éƒ¨é¦–åœˆã€‚</p>
      </header>

      <main class="bg-white rounded-lg shadow-lg p-6 space-y-8">
        <!-- ğŸ” å…¨æ–‡æª¢ç´¢ -->
        <div class="mb-6">
          <h2 class="text-2xl font-semibold border-b-2 border-cyan-200 pb-2 mb-4">ğŸ” å…¨æ–‡æª¢ç´¢</h2>
          <div class="flex gap-2 justify-center">
            <input id="search-input" type="text" placeholder="è¼¸å…¥åœ‹å­—æˆ–æ³¨éŸ³â€¦"
                   class="border rounded-lg px-3 py-2 w-64 focus:outline-none focus:ring-2 focus:ring-orange-400">
            <button id="search-button"
                    class="bg-orange-400 text-white px-4 py-2 rounded-lg hover:bg-orange-500 transition-colors">
              æœå°‹
            </button>
          </div>
          <div id="search-results" class="mt-4 space-y-3"></div>
        </div>

        <!-- â‘  æ³¨éŸ³ -->
        <div>
          <h2 class="text-2xl font-semibold border-b-2 border-cyan-200 pb-2 mb-4">â‘  é¸æ“‡æ³¨éŸ³</h2>
          <div id="zhuyin-list" class="flex flex-wrap gap-2 justify-center"></div>
        </div>

        <!-- â‘¡ éƒ¨ä»¶ -->
        <div>
          <h2 class="text-2xl font-semibold border-b-2 border-cyan-200 pb-2 mb-4">â‘¡ é¸æ“‡éƒ¨ä»¶</h2>
          <div id="component-list" class="flex flex-wrap gap-3 min-h-[7rem] items-center justify-center">
            <p id="component-placeholder" class="text-gray-400">è«‹å…ˆé¸æ“‡æ³¨éŸ³ç¬¦è™Ÿã€‚</p>
          </div>
        </div>
      </main>
    </div>

    <div id="results-page" class="page-hidden">
      <header class="text-center mb-8 relative">
        <button id="back-button" class="absolute left-0 top-1/2 -translate-y-1/2 bg-orange-400 text-white py-2 px-4 rounded-lg hover:bg-orange-500 transition-colors shadow">
          &larr; è¿”å›
        </button>
        <h1 class="text-4xl font-bold text-cyan-600">è­˜å­—çµæœ</h1>
      </header>

      <main class="bg-white rounded-lg shadow-lg p-6">
        <div id="petal-container" class="relative w-full flex justify-center items-center"></div>
      </main>
    </div>

    <footer class="text-center mt-8 text-sm text-gray-500 space-y-2">
      <p>å­—å…¸é€£çµè‡³ <a href="https://dict.concised.moe.edu.tw/" target="_blank" class="text-blue-500 hover:underline">æ•™è‚²éƒ¨ã€Šåœ‹èªè¾­å…¸ç°¡ç·¨æœ¬ã€‹</a>ã€‚</p>
      <div class="pt-4">
        <a href="https://portaly.cc/mamahowma/support" target="_blank" rel="noopener noreferrer" class="inline-block bg-gradient-to-r from-amber-400 to-orange-500 text-white font-semibold py-2 px-5 rounded-full shadow-md hover:scale-105 transition-transform">
          æ”¯æŒæˆ‘ç¹¼çºŒå‰µä½œåˆ†äº«ï¼Œè«‹æˆ‘å–æ¯å’–å•¡å§ â˜•
        </a>
      </div>
      <p class="pt-4">&copy; 2025 Christina Yu</p>
    </footer>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
/* =========================
   0) è³‡æ–™ï¼šæ”¹ç‚º fetch å¤–éƒ¨ JSON
   ========================= */
const DATA_DIR = 'data';
const MANIFEST_URL = `${DATA_DIR}/manifest.json`;
// å¿«å–è¼‰å…¥å¾Œçš„è³‡æ–™ï¼š{ "ã„…":[...], "ã„†":[...], ... }
const componentData = {};
// æœ‰è³‡æ–™çš„æ³¨éŸ³é›†åˆï¼ˆä¾†è‡ª manifestï¼‰
let availableSet = new Set();

// ä½ åŸæœ¬ UI ä½¿ç”¨çš„æ³¨éŸ³é †åºï¼ˆä¸æ”¹ï¼‰
const zhuyinSymbolsOrder = ["ã„…","ã„†","ã„‡","ã„ˆ","ã„‰","ã„Š","ã„‹","ã„Œ","ã„","ã„","ã„","ã„","ã„‘","ã„’","ã„“","ã„”","ã„•","ã„–","ã„—","ã„˜","ã„™","ã„§","ã„¨","ã„©","ã„š","ã„›","ã„œ","ã„","ã„","ã„Ÿ","ã„ ","ã„¡","ã„¢","ã„£","ã„¤","ã„¥","ã„¦"];

/* =========================
   â‘  DOM åƒç…§ï¼ˆä¿æŒä¸è®Šï¼‰
   ========================= */
const RAD_NORMALIZE = new Map(Object.entries({
  "äº»":"äºº","è¡¤":"è¡£","æ°µ":"æ°´","æœˆ":"è‚‰","âº¼":"è‚‰","æ‰Œ":"æ‰‹","å¿„":"å¿ƒ","çŠ­":"çŠ¬",
  "é£ ":"é£Ÿ","é¥£":"é£Ÿ","ç¤»":"ç¤º","è‰¹":"è‰¸","è‰¸":"è‰¸","ç³¹":"ç³¸","çºŸ":"ç³¸",
  "é’…":"é‡‘","é‡’":"é‡‘","è® ":"è¨€","è¾¶":"è¾µ","é˜":"é˜œ"
}));
function canonicalRad(rad){ return RAD_NORMALIZE.get(rad) || rad || ""; }

const selectionPage        = document.getElementById('selection-page');
const resultsPage          = document.getElementById('results-page');
const zhuyinList           = document.getElementById('zhuyin-list');
const componentList        = document.getElementById('component-list');
const componentPlaceholder = document.getElementById('component-placeholder');
const petalContainer       = document.getElementById('petal-container');
const backButton           = document.getElementById('back-button');
const searchInput          = document.getElementById('search-input');
const searchButton         = document.getElementById('search-button');
const searchResults        = document.getElementById('search-results');

let selectedZhuyinBtn=null, currentItem=null;

/* =========================
   â‘¡ è³‡æ–™è®€å–
   - å…ˆæŠ“ manifest.jsonï¼ˆåˆ—å‡ºæœ‰è³‡æ–™çš„æ³¨éŸ³ï¼‰
   - ç‚ºç¶­æŒå…¨æ–‡æœå°‹åŠŸèƒ½ï¼Œé è¼‰ manifest ä¸­æ‰€æœ‰æª”
   ========================= */
async function loadManifest() {
  const res = await fetch(MANIFEST_URL);
  if (!res.ok) throw new Error('è¼‰å…¥ manifest.json å¤±æ•—');
  // manifest å¯ç‚ºï¼š["ã„…","ã„†",...] æˆ– {"ã„…":true,...} å‡æ”¯æ´
  const manifest = await res.json();
  const keys = Array.isArray(manifest) ? manifest
              : (manifest && typeof manifest === 'object' ? Object.keys(manifest) : []);
  availableSet = new Set(keys);
  return keys;
}
async function loadOneSymbol(symbol){
  if (componentData[symbol]) return componentData[symbol];
  const url = `${DATA_DIR}/${encodeURIComponent(symbol)}.json`;
  const res = await fetch(url);
  if (!res.ok) { componentData[symbol] = []; return componentData[symbol]; }
  const data = await res.json();
  componentData[symbol] = (data && Array.isArray(data.items)) ? data.items : [];
  return componentData[symbol];
}
async function preloadAll(keys){
  await Promise.all(keys.map(k => loadOneSymbol(k)));
}

/* =========================
   â‘¢ æ³¨éŸ³æŒ‰éˆ•ï¼ˆç°/å¯é»ï¼‰
   ========================= */
function buildZhuyinButtons(){
  zhuyinList.innerHTML = '';
  zhuyinSymbolsOrder.forEach(symbol=>{
    const btn=document.createElement('button');
    btn.textContent=symbol; btn.dataset.zhuyin=symbol;
    const has = availableSet.has(symbol);
    if(!has){
      btn.disabled=true;
      btn.className="text-lg border-2 border-gray-200 bg-gray-100 text-gray-400 rounded-md w-10 h-10 flex items-center justify-center cursor-not-allowed opacity-50";
    }else{
      btn.className="text-lg border-2 border-gray-300 rounded-md w-10 h-10 flex items-center justify-center cursor-pointer transition-colors hover:bg-orange-100";
      btn.addEventListener('click', handleZhuyinClick);
    }
    zhuyinList.appendChild(btn);
  });
}

/* =========================
   â‘£ æœå°‹ï¼ˆä¿æŒåŸæœ¬è¡Œç‚ºï¼Œç”¨å¿«å–è³‡æ–™ï¼‰
   ========================= */
function searchCharacters(query){
  const q = (query||'').trim(); if(!q) return [];
  const out = [];
  for(const zy of Object.keys(componentData)){
    (componentData[zy]||[]).forEach(item=>{
      if((item.component.char||'').includes(q) || (item.component.zhuyin||'').includes(q))
        out.push({type:'component', char:item.component.char, zhuyin:item.component.zhuyin});
      (item.characters||[]).forEach(c=>{
        if((c.char||'').includes(q) || (c.zhuyin||'').includes(q))
          out.push({type:'character', char:c.char, zhuyin:c.zhuyin, parent:item.component.char});
      });
    });
  }
  return out;
}
function findComponentItemByChar(ch){
  for(const zy of Object.keys(componentData)){
    for(const it of (componentData[zy]||[])){
      if(it.component.char===ch) return it;
    }
  }
  return null;
}
function renderSearchResults(results){
  searchResults.innerHTML = '';
  if(!results.length){ searchResults.innerHTML='<p class="text-gray-500">æŸ¥ç„¡çµæœ</p>'; return; }
  const header = document.createElement('div');
  header.className='text-sm text-gray-600';
  header.textContent=`æœå°‹çµæœï¼ˆ${results.length} ç­†ï¼‰`;
  searchResults.appendChild(header);

  results.forEach(r=>{
    const btn=document.createElement('button');
    btn.type='button';
    btn.className='w-full text-left bg-white border rounded-lg p-3 shadow hover:bg-orange-50';
    const extra = r.type==='character' ? `ï¼ˆéƒ¨ä»¶ï¼š<b>${r.parent}</b>ï¼‰` : 'ï¼ˆéƒ¨ä»¶ï¼‰';
    btn.innerHTML = `
      <span class="text-2xl font-bold mr-2">${r.char}</span>
      <span class="text-gray-600">${r.zhuyin||''}</span> ${extra}
    `;
    btn.addEventListener('click', ()=>{
      const target = r.type==='character' ? r.parent : r.char;
      const item = findComponentItemByChar(target);
      if(item) handleComponentClick(item);
    });
    searchResults.appendChild(btn);
  });
}
searchButton.addEventListener('click', ()=> renderSearchResults(searchCharacters(searchInput.value)));
searchInput.addEventListener('keypress', e=>{
  if(e.key==='Enter') renderSearchResults(searchCharacters(searchInput.value));
});

/* =========================
   â‘¤ æ³¨éŸ³ â†’ éƒ¨ä»¶åˆ—è¡¨ï¼ˆé»æ“Šè¼‰å…¥ï¼‰
   ========================= */
async function handleZhuyinClick(e){
  const zy=e.target.dataset.zhuyin;
  // ç¢ºä¿è©²æ³¨éŸ³è³‡æ–™å·²è¼‰å…¥
  if (!componentData[zy]) await loadOneSymbol(zy);
  const items=componentData[zy]||[];
  if(selectedZhuyinBtn) selectedZhuyinBtn.classList.remove('btn-selected');
  selectedZhuyinBtn=e.target; selectedZhuyinBtn.classList.add('btn-selected');

  componentList.innerHTML='';
  if(items.length){
    componentPlaceholder.style.display='none';
    items.forEach(item=>{
      const b=document.createElement('button');
      b.textContent=item.component.char;
      b.className="text-2xl font-bold border-2 border-gray-300 rounded-lg w-16 h-16 flex items-center justify-center cursor-pointer transition-all hover:bg-orange-100 hover:border-orange-400";
      b.addEventListener('click', ()=>handleComponentClick(item));
      componentList.appendChild(b);
    });
  }else{
    componentPlaceholder.style.display='block';
    componentPlaceholder.textContent='é€™å€‹æ³¨éŸ³æ²’æœ‰å°æ‡‰çš„éƒ¨ä»¶å–”ï¼';
  }
}

/* =========================
   â‘¥ èŠ±ç“£æ¸²æŸ“ï¼ˆä¿æŒåŸç‰ˆï¼‰
   ========================= */
function computeLayout(petalCount){
  const W = window.innerWidth;
  const isNarrow = W < 390;
  const isMobile = W < 640 && !isNarrow;

  let centerWH, centerText, size, centerRadius, dotRadius, petalRadius;
  const dotSizeNarrow = 32;
  const dotSizeDesktop = 36;

  if(isNarrow){
    centerWH = 'w-24 h-24'; centerText = 'text-4xl';
    centerRadius = 48; dotRadius = dotSizeNarrow / 2;
    if(petalCount<=8){
      size={container:'w-20 h-20', char:'text-4xl', zhuyin:'text-sm', tone:'text-sm'};
      petalRadius = 40;
    } else if(petalCount<=12){
      size={container:'w-[72px] h-[72px]', char:'text-3xl',  zhuyin:'text-xs', tone:'text-xs'};
      petalRadius = 36;
    } else{
      size={container:'w-16 h-16', char:'text-lg',  zhuyin:'text-[10px]', tone:'text-[10px]'};
      petalRadius = 32;
    }
  } else if(isMobile){
    centerWH = 'w-24 h-24'; centerText = 'text-4xl';
    centerRadius = 48; dotRadius = dotSizeNarrow / 2;
    if(petalCount<=8){
      size={container:'w-20 h-20', char:'text-4xl', zhuyin:'text-sm', tone:'text-sm'};
      petalRadius = 40;
    } else if(petalCount<=12){
      size={container:'w-[76px] h-[76px]', char:'text-4xl', zhuyin:'text-sm', tone:'text-sm'};
      petalRadius = 38;
    } else{
      size={container:'w-16 h-16', char:'text-3xl', zhuyin:'text-xs', tone:'text-xs'};
      petalRadius = 32;
    }
  } else {
    centerWH = 'w-28 h-28'; centerText = 'text-5xl';
    centerRadius = 56; dotRadius = dotSizeDesktop / 2;
    if(petalCount<=8){
      size={container:'w-24 h-24', char:'text-4xl', zhuyin:'text-sm', tone:'text-sm'};
      petalRadius = 48;
    } else if(petalCount<=12){
      size={container:'w-20 h-20', char:'text-4xl', zhuyin:'text-sm', tone:'text-sm'};
      petalRadius = 40;
    } else{
      size={container:'w-16 h-16', char:'text-2xl', zhuyin:'text-xs', tone:'text-xs'};
      petalRadius = 32;
    }
  }
  const centerBorderWidth = 4;
  const R2 = centerRadius + centerBorderWidth + dotRadius;
  const R = R2 + dotRadius + petalRadius;
  const totalDiameter = (R + petalRadius) * 2;
  const minH = totalDiameter + 40;
  return { isNarrow, isMobile, centerWH, centerText, R, size, R2, minH };
}

function createZhuyinHTML(zhuyinString, sizeClass, charClass){
  const tones=['ËŠ','Ë‡','Ë‹','Ë™'];
  const last=zhuyinString ? zhuyinString.slice(-1) : '';
  let base='', tone='';
  if(tones.includes(last)){ base=zhuyinString.slice(0,-1); tone=last; }
  else{ base=zhuyinString||''; tone=''; }
  return base.split('').map((ch,i)=>{
    if(i===base.length-1 && tone){
      return `<span class="relative ${charClass}">${ch}<span class="absolute -top-1 -right-3 ${sizeClass}">${tone}</span></span>`;
    }
    return `<span class="${charClass}">${ch}</span>`;
  }).join('');
}

function createPetalElement(charObj,size){
  const link=document.createElement('a');
  link.href=`https://dict.concised.moe.edu.tw/search.jsp?word=${encodeURIComponent(charObj.char)}`;
  link.target='_blank'; link.rel='noopener noreferrer';

  const wrap=document.createElement('div');
  wrap.className=`absolute flex items-center justify-center bg-pink-200 border-2 border-pink-300 rounded-full ${size.container} transition-transform hover:scale-110 hover:bg-pink-300 shadow petal-char-container`;

  const big=document.createElement('span');
  big.className=`${size.char} font-medium`; big.textContent=charObj.char;

  const zy=document.createElement('div');
  zy.className='zhuyin-col text-gray-600';
  zy.innerHTML=createZhuyinHTML(charObj.zhuyin||'', size.tone, size.zhuyin);

  wrap.appendChild(big); wrap.appendChild(zy); link.appendChild(wrap);
  return { link, container:wrap };
}

function createRadicalDot(label,isNarrow,isMobile){
  const txt = canonicalRad(label);
  const el=document.createElement('div');
  const cls = isNarrow ? 'w-8 h-8 text-sm' : (isMobile ? 'w-8 h-8 text-sm' : 'w-9 h-9 text-base');
  el.className = `radical-dot absolute bg-emerald-100 border border-emerald-300 rounded-full ${cls} flex items-center justify-center text-emerald-700 shadow font-normal`;
  el.textContent = txt || '';
  el.style.pointerEvents = 'none';
  return el;
}

function renderPetalView(item){
  petalContainer.innerHTML='';
  const characters=item.characters||[];
  const n=characters.length;
  const L=computeLayout(n);

  const centerLink=document.createElement('a');
  centerLink.href=`https://dict.concised.moe.edu.tw/search.jsp?word=${encodeURIComponent(item.component.char)}`;
  centerLink.target='_blank'; centerLink.rel='noopener noreferrer';

  const centerDiv=document.createElement('div');
  centerDiv.className=`center-char-container absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-yellow-200 border-4 border-yellow-300 rounded-full ${L.centerWH} flex items-center justify-center z-20 transition-transform hover:scale-110 shadow-lg`;

  const centerChar=document.createElement('span');
  centerChar.className=`${L.centerText} font-bold`;
  centerChar.textContent=item.component.char;

  const centerZh=document.createElement('div');
  centerZh.className="zhuyin-col text-gray-700 font-medium";
  centerZh.innerHTML=createZhuyinHTML(item.component.zhuyin||'', 'text-sm', 'text-sm');

  centerDiv.appendChild(centerChar);
  centerDiv.appendChild(centerZh);

  if(item.component.radical){
    const pill=document.createElement('div');
    pill.className='absolute -bottom-1 left-1/2 -translate-x-1/2 bg-emerald-100 text-emerald-800 border border-emerald-300 rounded-full px-2 py-[2px] text-sm';
    pill.textContent = canonicalRad(item.component.radical);
    centerDiv.appendChild(pill);
  }

  centerLink.appendChild(centerDiv);
  petalContainer.appendChild(centerLink);

  petalContainer.style.minHeight = L.minH + 'px';

  const step=(2*Math.PI)/Math.max(n,1);
  characters.forEach((c,i)=>{
    const a = i*step - Math.PI/2;
    const x = Math.cos(a)*L.R;
    const y = Math.sin(a)*L.R;

    const {link,container}=createPetalElement(c,L.size);
    container.style.transform=`translate(-50%,-50%) translate(${x}px,${y}px)`;
    container.style.top='50%'; container.style.left='50%';
    petalContainer.appendChild(link);

    if(c.radical){
      const rx = Math.cos(a)*L.R2, ry = Math.sin(a)*L.R2;
      const dot = createRadicalDot(c.radical, L.isNarrow, L.isMobile);
      dot.style.left='50%'; dot.style.top='50%';
      dot.style.transform=`translate(-50%,-50%) translate(${rx}px,${ry}px)`;
      petalContainer.appendChild(dot);
    }
  });
}

function handleComponentClick(item){
  currentItem=item;
  selectionPage.classList.add('page-hidden');
  resultsPage.classList.remove('page-hidden');
  renderPetalView(item);
}
backButton.addEventListener('click', ()=>{
  resultsPage.classList.add('page-hidden');
  selectionPage.classList.remove('page-hidden');
});

window.addEventListener('resize', ()=>{
  if(!resultsPage.classList.contains('page-hidden') && currentItem){
    renderPetalView(currentItem);
  }
});

/* =========================
   â–¶ åˆå§‹åŒ–ï¼šæŠ“ manifest â†’ é è¼‰ â†’ ç•«æŒ‰éˆ•
   ========================= */
(async () => {
  try{
    const keys = await loadManifest();     // ä¾‹å¦‚ ["ã„…","ã„†","ã„‡", ...]
    await preloadAll(keys);                // ç‚ºäº†ç¶­æŒå…¨æ–‡æœå°‹å¯ç”¨
    buildZhuyinButtons();                  // ç…§åŸæœ¬é †åºç•«æŒ‰éˆ•ï¼Œæœªåˆ—åœ¨ manifest çš„ç°æ‰
  }catch(err){
    console.error(err);
    zhuyinList.innerHTML = '<p class="text-red-500">è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ data/manifest.json èˆ‡å„æ³¨éŸ³æª”ã€‚</p>';
  }
})();
});
</script>
</body>
</html>
