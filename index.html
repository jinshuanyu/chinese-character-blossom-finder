<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>部件 × 注音 對照（花瓣）</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .page-hidden{display:none}
    .btn-selected{background:#fed7aa;border-color:#fb923c}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    /* 花瓣舞台 */
    .petal-stage{position:relative;width:100%;aspect-ratio:1/1;max-width:720px;margin:0 auto;background:#fff;border:1px solid #e5e7eb;border-radius:1rem;box-shadow:0 1px 0 rgba(0,0,0,.02)}
    .center-node{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:min(38%,240px);height:min(38%,240px);border:2px solid #f97316;border-radius:1rem;background:#fff;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:.25rem}
    .center-node .char{font-size:clamp(40px,7vw,72px);font-weight:800;line-height:1}
    .center-node .zy{font-size:clamp(14px,2.5vw,18px);color:#475569}
    .center-node .rad{font-size:12px;color:#64748b}
    .petal{position:absolute;transform:translate(-50%,-50%);width:min(30%,180px);height:min(30%,180px);border:1px solid #e5e7eb;border-radius:1rem;background:#fff;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:.25rem;box-shadow:0 1px 0 rgba(0,0,0,.02);transition:.15s ease}
    .petal:hover{border-color:#fb923c;background:#fff7ed;transform:translate(-50%,-50%) scale(1.04)}
    .petal .char{font-size:clamp(28px,5.2vw,52px);font-weight:800;line-height:1}
    .petal .zy{font-size:clamp(12px,2vw,16px);color:#475569}
    .petal .rad{font-size:11px;color:#64748b}
    .ring-dot{position:absolute;width:10px;height:10px;border-radius:9999px;background:#94a3b8;opacity:.4;transform:translate(-50%,-50%)}
    @media (max-width:480px){
      .center-node{width:44%;height:44%}
      .petal{width:34%;height:34%}
    }
  </style>
</head>
<body class="bg-orange-50 text-slate-800">
  <header class="sticky top-0 z-10 bg-white/85 backdrop-blur border-b">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <h1 class="text-xl font-extrabold">部件 × 注音 對照（花瓣）</h1>
      <div class="ml-auto text-sm text-slate-500">
        資料：<span class="mono">/data/manifest.json</span> + <span class="mono">/data/*.json</span>
      </div>
    </div>
  </header>

  <!-- 首頁：注音 → 部件 -->
  <main id="selection-page" class="max-w-6xl mx-auto px-4 py-6">
    <section class="mb-6">
      <h2 class="text-lg font-bold mb-2">注音索引</h2>
      <div id="zhuyin-list" class="grid grid-cols-12 md:grid-cols-18 gap-2"></div>
      <p class="text-sm text-slate-500 mt-2">未列於 <span class="mono">/data/manifest.json</span> 的注音會被灰掉。</p>
    </section>

    <section class="mb-6">
      <h2 class="text-lg font-bold mb-2">部件</h2>
      <div id="component-placeholder" class="text-slate-500">請先選一個注音。</div>
      <div id="component-list" class="grid grid-cols-6 md:grid-cols-10 gap-3"></div>
    </section>
  </main>

  <!-- 詳細頁：花瓣視圖 -->
  <section id="results-page" class="page-hidden max-w-6xl mx-auto px-4 py-6">
    <div class="mb-4 flex items-center gap-3">
      <button id="back-button" class="px-3 py-2 border rounded-md hover:bg-orange-100">&larr; 返回</button>
      <h2 class="text-lg font-bold">花瓣視圖</h2>
    </div>
    <!-- ✅ 你的原容器ID（若你原本叫 petal-container，就沿用；否則這裡也提供） -->
    <div id="petal-container" class="petal-stage"></div>
  </section>

  <footer class="max-w-6xl mx-auto px-4 py-10 text-sm text-slate-500">
    <p>把注音資料拆成 <span class="mono">/data/ㄅ.json</span> …；啟用清單由 <span class="mono">/data/manifest.json</span> 控制。</p>
  </footer>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // ===== 注音順序 =====
    const zhuyinSymbols = ["ㄅ","ㄆ","ㄇ","ㄈ","ㄉ","ㄊ","ㄋ","ㄌ","ㄍ","ㄎ","ㄏ","ㄐ","ㄑ","ㄒ","ㄓ","ㄔ","ㄕ","ㄖ","ㄗ","ㄘ","ㄙ","ㄧ","ㄨ","ㄩ","ㄚ","ㄛ","ㄜ","ㄝ","ㄞ","ㄟ","ㄠ","ㄡ","ㄢ","ㄣ","ㄤ","ㄥ","ㄦ"];

    // ===== DOM =====
    const selectionPage = document.getElementById('selection-page');
    const resultsPage   = document.getElementById('results-page');
    const zhuyinList    = document.getElementById('zhuyin-list');
    const componentList = document.getElementById('component-list');
    const componentPlaceholder = document.getElementById('component-placeholder');
    const petalContainer = document.getElementById('petal-container'); // ✅ 花瓣容器固定用這個ID
    const backButton    = document.getElementById('back-button');

    // ===== 狀態 =====
    let componentData = {};              // 外部載入
    let manifest = null;                 // { symbols: [{zy: "ㄅ"}, ...] }
    let selectedZhuyinBtn = null;
    let currentItem = null;

    // ===== 載 manifest（只列有資料的注音）=====
    async function loadManifest(){
      try{
        const res = await fetch('data/manifest.json', {cache:'no-store'});
        if(!res.ok) return { symbols: [] };
        return await res.json();
      }catch(e){
        console.error('loadManifest error', e);
        return { symbols: [] };
      }
    }

    // ===== 依 manifest 載各注音 JSON 到 componentData =====
    async function loadAllComponentData(zyList){
      componentData = {};
      const man = await loadManifest();
      const available = new Set((man.symbols||[]).map(x=>x.zy));
      for(const zy of zyList){
        if(available.size && !available.has(zy)){
          componentData[zy] = [];
          continue;
        }
        try{
          const r = await fetch('data/'+encodeURIComponent(zy)+'.json', {cache:'no-store'});
          if(r.ok){
            const arr = await r.json();
            componentData[zy] = Array.isArray(arr) ? arr : [];
          }else{
            componentData[zy] = [];
          }
        }catch(_){
          componentData[zy] = [];
        }
      }
    }

    // ===== 入口：載入 → 畫按鈕 =====
    (async function init(){
      manifest = await loadManifest();
      await loadAllComponentData(zhuyinSymbols);
      renderZhuyinButtons();
    })();

    // ===== 畫注音按鈕（未列於 manifest 的灰掉）=====
    function renderZhuyinButtons(){
      const available = new Set((manifest.symbols||[]).map(x=>x.zy));
      zhuyinList.innerHTML = '';
      zhuyinSymbols.forEach(symbol=>{
        const btn = document.createElement('button');
        btn.textContent = symbol; btn.dataset.zhuyin = symbol;
        const hasData = (componentData[symbol]||[]).length > 0;
        const enabled = available.size ? available.has(symbol) : true;

        if(!enabled || !hasData){
          // ✅ 兩條件任一不符就灰掉（你要的是預先灰掉沒資料）
          btn.disabled = true;
          btn.className = "text-lg border-2 border-gray-200 bg-gray-100 text-gray-400 rounded-md w-10 h-10 flex items-center justify-center cursor-not-allowed opacity-50";
        }else{
          btn.className = "text-lg border-2 border-gray-300 rounded-md w-10 h-10 flex items-center justify-center cursor-pointer transition-colors hover:bg-orange-100";
          btn.addEventListener('click', handleZhuyinClick);
        }
        zhuyinList.appendChild(btn);
      });
    }

    // ===== 點注音 → 列部件按鈕 =====
    function handleZhuyinClick(e){
      const zy = e.currentTarget.dataset.zhuyin;
      const items = componentData[zy] || [];

      if (selectedZhuyinBtn) selectedZhuyinBtn.classList.remove('btn-selected');
      selectedZhuyinBtn = e.currentTarget; selectedZhuyinBtn.classList.add('btn-selected');

      componentList.innerHTML = '';
      if (items.length) {
        componentPlaceholder.style.display = 'none';
        items.forEach(item => {
          const b = document.createElement('button');
          b.className = "text-2xl font-bold border-2 border-gray-300 rounded-lg w-16 h-16 flex items-center justify-center cursor-pointer transition-all hover:bg-orange-100 hover:border-orange-400";
          b.textContent = item.component.char;
          b.addEventListener('click', () => handleComponentClick(item));
          componentList.appendChild(b);
        });
      } else {
        componentPlaceholder.style.display = 'block';
        componentPlaceholder.textContent = '這個注音目前沒有資料。';
      }
    }

    // ===== 點部件 → 切頁 + 花瓣渲染 =====
    function handleComponentClick(item){
      currentItem = item;
      selectionPage.classList.add('page-hidden');
      resultsPage.classList.remove('page-hidden');
      renderPetalView(item); // ✅ 關鍵：渲染花瓣
    }

    backButton.addEventListener('click', ()=>{
      resultsPage.classList.add('page-hidden');
      selectionPage.classList.remove('page-hidden');
      currentItem = null;
      // 回來時保持已選注音與部件清單
    });

    // ===== 花瓣布局：等角圓環 =====
    function computeLayout(count){
      const pts = [];
      if(count<=0) return pts;
      const R = 42; // 半徑（占容器%）
      const startDeg = -90; // 由上方開始
      for(let i=0;i<count;i++){
        const ang = (startDeg + i*(360/count)) * Math.PI/180;
        const x = 50 + R*Math.cos(ang);
        const y = 50 + R*Math.sin(ang);
        pts.push({x,y});
      }
      return pts;
    }

    // ===== 真的畫花瓣 =====
    function renderPetalView(item){
      const chars = Array.isArray(item.characters) ? item.characters : [];
      const pts = computeLayout(chars.length);

      // 清空舞台
      petalContainer.innerHTML = '';
      petalContainer.classList.add('petal-stage'); // 保險：若外層沒class則補上

      // 中心
      const center = document.createElement('div');
      center.className = 'center-node';
      center.innerHTML = `
        <div class="char">${item.component.char}</div>
        <div class="zy">${item.component.zhuyin || ''}</div>
        <div class="rad">部首：${normalizeRad(item.component.radical || '')}</div>
      `;
      petalContainer.appendChild(center);

      // 輔助點（四方位）
      [0,90,180,270].forEach(a=>{
        const ang=a*Math.PI/180, R=42;
        const x=50+R*Math.cos(ang), y=50+R*Math.sin(ang);
        const d=document.createElement('div');
        d.className='ring-dot'; d.style.left=x+'%'; d.style.top=y+'%';
        petalContainer.appendChild(d);
      });

      // 花瓣
      chars.forEach((c,idx)=>{
        const p = document.createElement('div');
        p.className = 'petal';
        p.style.left = pts[idx].x+'%';
        p.style.top  = pts[idx].y+'%';
        p.innerHTML = `
          <div class="char">${c.char}</div>
          <div class="zy">${c.zhuyin || ''}</div>
          <div class="rad">部首：${normalizeRad(c.radical || '')}</div>
        `;
        petalContainer.appendChild(p);
      });
    }

    // ===== 偏旁正字化（維持你既有習慣）=====
    const RAD_NORMALIZE = new Map(Object.entries({
      "亻":"人","衤":"衣","氵":"水","月":"肉","⺼":"肉","扌":"手","忄":"心","犭":"犬",
      "飠":"食","饣":"食","礻":"示","艹":"艸","艸":"艸","糹":"糸","纟":"糸","钅":"金","釒":"金",
      "讠":"言","辶":"辵","阝":"阜"
    }));
    function normalizeRad(rad){ return RAD_NORMALIZE.get(rad) || rad || ''; }

    // ===== RWD：縮放時重畫（保持視覺中心）=====
    window.addEventListener('resize', ()=>{
      if(!resultsPage.classList.contains('page-hidden') && currentItem){
        renderPetalView(currentItem);
      }
    });
  });
  </script>
</body>
</html>
