<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>èŠ±ç“£è­˜å­—æŸ¥å­—å™¨ï¼ˆå«éƒ¨é¦–åœˆï¼‰</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Iansui&display=swap" rel="stylesheet">
  <style>
    body{font-family:"Iansui", "DFKai-SB", "BiauKai", "KaiTi", "æ¨™æ¥·é«”", serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
    .btn-selected{background:#fb923c;color:#fff;border-color:#f97316}
    .page-hidden{display:none}
    #petal-container{transition:min-height .3s ease}
    .petal-char-container,.center-char-container{transform:translateZ(0)}
    .zhuyin-col{display:flex;flex-direction:column;justify-content:center;align-items:center;line-height:1;margin-left:2px}
    /* éƒ¨é¦–åœˆå°é» */
    .radical-dot{
      position:absolute; display:flex; align-items:center; justify-content:center;
      width:2.25rem; height:2.25rem; border-radius:9999px;
      background:#e0f2f1; color:#0f766e; border:1px solid #99f6e4;
      font-weight:bold; font-size:1.1rem; line-height:1;
      transform:translate(-50%,-50%);
    }
  </style>
</head>
<body class="bg-gray-50 p-4 min-h-screen">

  <div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">èŠ±ç“£è­˜å­—æŸ¥å­—å™¨</h1>

    <!-- æ³¨éŸ³ç¬¦è™ŸæŒ‰éˆ•å€ -->
    <div id="zhuyin-container" class="flex flex-wrap gap-2 justify-center p-4 border rounded-xl bg-white shadow-lg mb-6">
      <!-- æŒ‰éˆ•å°‡ç”± JavaScript è¼‰å…¥ manifest.json å¾Œå‹•æ…‹ç”Ÿæˆ -->
      <div class="text-gray-500">æ­£åœ¨è¼‰å…¥æ³¨éŸ³ç¬¦è™Ÿæ¸…å–®...</div>
    </div>

    <!-- èŠ±ç“£é¡¯ç¤ºå€ -->
    <div id="petal-container" class="relative bg-white shadow-xl rounded-2xl border flex flex-col items-center justify-center p-4 min-h-[400px]">
      <div id="loading-message" class="text-xl font-medium text-gray-500 p-10">
        æ­£åœ¨è¼‰å…¥è³‡æ–™...
      </div>
      <!-- èŠ±ç“£åœ–å°‡åœ¨é€™è£¡æ¸²æŸ“ -->
    </div>
  </div>

  <script>
    // å…¨åŸŸç‹€æ…‹ç®¡ç†
    let currentZhuyin = '';
    let currentData = null; // å„²å­˜ç•¶å‰è¼‰å…¥çš„è³‡æ–™

    const zhuyinContainer = document.getElementById('zhuyin-container');
    const petalContainer = document.getElementById('petal-container');
    const loadingMessage = document.getElementById('loading-message');

    // --- è¼”åŠ©å‡½å¼ (Helper Functions) ---

    /**
     * å–å¾—éƒ¨é¦–çš„è¦ç¯„å½¢å¼ (å‡è¨­é€™æ˜¯æ‚¨åŸæœ¬çš„é‚è¼¯)
     * @param {string} radical - éƒ¨é¦–å­—ä¸²ã€‚
     * @returns {string} - è¦ç¯„éƒ¨é¦–ã€‚
     */
    function canonicalRad(radical) {
      if (!radical) return '';
      // é€™è£¡å¯ä»¥åŠ å…¥æ›´è¤‡é›œçš„éƒ¨é¦–è¦ç¯„é‚è¼¯ï¼Œç›®å‰åªè¿”å›ç¬¬ä¸€å€‹å­—
      return radical.length > 1 ? radical[0] : radical;
    }

    /**
     * å‰µå»ºä¸€å€‹å­—å…ƒèŠ±ç“£å…ƒç´  (å¤–åœˆæˆ–å…§æ ¸)
     * @param {Object} item - åŒ…å« char, zhuyin, radical çš„ç‰©ä»¶ã€‚
     * @param {number} size - å…ƒç´ çš„å°ºå¯¸ (px)ã€‚
     * @returns {{link: HTMLElement, container: HTMLElement}} - åŒ…å« link å’Œ container çš„ç‰©ä»¶ã€‚
     */
    function createPetalElement(item, size) {
      const link = document.createElement('a');
      link.href = `https://www.moedict.tw/${item.char}`;
      link.target = '_blank';
      link.title = `å­—: ${item.char}, æ³¨éŸ³: ${item.zhuyin}, éƒ¨é¦–: ${item.radical || 'ç„¡'}`;

      const container = document.createElement('div');
      container.className = `petal-char-container absolute w-[${size}px] h-[${size}px] flex items-center justify-center bg-yellow-50 text-gray-900 rounded-lg shadow-md border-2 border-yellow-200 hover:bg-yellow-100 transition-colors cursor-pointer text-[${size * 0.7}px] font-extrabold`;
      container.textContent = item.char;

      link.appendChild(container);

      return { link, container };
    }

    /**
     * å‰µå»ºéƒ¨é¦–åœˆå°é»
     * @param {Object} item - åŒ…å« char, zhuyin, radical çš„ç‰©ä»¶ã€‚
     * @returns {HTMLElement} - éƒ¨é¦–é»å…ƒç´ ã€‚
     */
    function createRadicalDot(item) {
      const dot = document.createElement('div');
      dot.className = 'radical-dot';
      dot.textContent = canonicalRad(item.radical);
      dot.title = `å­—: ${item.char}, éƒ¨é¦–: ${canonicalRad(item.radical)}`;
      return dot;
    }

    // --- æ ¸å¿ƒæ¸²æŸ“èˆ‡è³‡æ–™è¼‰å…¥é‚è¼¯ ---

    /**
     * æ¸²æŸ“èŠ±ç“£åœ–ã€‚
     * @param {Array<Object>} data - è¼‰å…¥çš„è³‡æ–™é™£åˆ—ï¼Œæ¯å€‹å…ƒç´ åŒ…å« component å’Œ charactersã€‚
     */
    function renderPetals(data) {
      petalContainer.innerHTML = ''; // æ¸…ç©ºèˆŠå…§å®¹
      if (!data || data.length === 0) {
        petalContainer.innerHTML = '<div class="p-8 text-gray-500 text-center">æ­¤æ³¨éŸ³ä¸‹æ²’æœ‰ç›¸é—œå­—å…ƒè³‡æ–™ã€‚</div>';
        return;
      }

      // æ¯å€‹ä¸­å¿ƒå­—çš„æ¸²æŸ“
      data.forEach((item, index) => {
        const { characters } = item;
        const n = characters.length;
        const centerIndex = data.length === 1 ? 0 : index;

        // ä½ˆå±€åƒæ•¸ (Layout Constants) - æ ¹æ“šè³‡æ–™é‡å‹•æ…‹èª¿æ•´
        const totalItems = data.length;
        const gridCols = Math.min(Math.ceil(Math.sqrt(totalItems)), 4);
        const gridRows = Math.ceil(totalItems / gridCols);
        
        // åŸºæœ¬å°ºå¯¸èˆ‡é–“è· (å‡è¨­å®¹å™¨æœ€å¤§å¯¬åº¦ 800px)
        const maxW = Math.min(petalContainer.clientWidth, 800);
        const cellWidth = maxW / gridCols;
        const cellHeight = 250; // æ¯å€‹èŠ±ç“£å€åŸŸçš„é è¨­é«˜åº¦
        
        const L = {
            size: 40, // å–®å€‹å­—å…ƒæ¡†å¤§å° (px)
            R: 80, // èŠ±ç“£åŠå¾‘ (å¤–åœˆ)
            R2: 120, // éƒ¨é¦–åœˆåŠå¾‘
            minH: gridRows * cellHeight, // å®¹å™¨æœ€å°é«˜åº¦
        };

        const col = centerIndex % gridCols;
        const row = Math.floor(centerIndex / gridCols);
        
        // å‰µå»ºèŠ±ç“£å®¹å™¨
        const flowerDiv = document.createElement('div');
        flowerDiv.className = 'absolute';
        // è¨ˆç®—ä½ç½®
        const centerX = col * cellWidth + cellWidth / 2;
        const centerY = row * cellHeight + cellHeight / 2;
        
        flowerDiv.style.left = `${centerX}px`;
        flowerDiv.style.top = `${centerY}px`;
        flowerDiv.style.transform = 'translate(-50%, -50%)'; // ä¸­å¿ƒé»

        // ç¢ºä¿å®¹å™¨é«˜åº¦è¶³å¤ 
        petalContainer.style.minHeight = L.minH + 'px';


        // ğŸŒ¸ å…§æ ¸å­— (Component/ä¸­å¿ƒå­—)
        const { link: centerLink, container: centerDiv } = createPetalElement(item.component, L.size + 10);
        centerDiv.classList.add('center-char-container', 'border-yellow-400', 'bg-yellow-200');
        centerDiv.classList.remove('shadow-md');
        centerDiv.style.fontSize = `${(L.size + 10) * 0.7}px`;
        centerDiv.style.width = `${L.size + 10}px`;
        centerDiv.style.height = `${L.size + 10}px`;

        // åŠ å…¥æ³¨éŸ³é¡¯ç¤º
        const zhuyinCol = document.createElement('div');
        zhuyinCol.className = 'zhuyin-col absolute top-1/2 right-0 transform translate-x-full -translate-y-1/2 pr-1 text-xs text-gray-600';
        item.component.zhuyin.split('').forEach(z => {
            const span = document.createElement('span');
            span.textContent = z;
            zhuyinCol.appendChild(span);
        });
        centerDiv.appendChild(zhuyinCol);


        // åŠ å…¥éƒ¨é¦–å°æ¨™
        if (item.component.radical) {
          const pill = document.createElement('div');
          pill.className = 'absolute -bottom-1 left-1/2 -translate-x-1/2 bg-emerald-100 text-emerald-800 border border-emerald-300 rounded-full px-2 py-[2px] text-sm';
          pill.textContent = canonicalRad(item.component.radical);
          centerDiv.appendChild(pill);
        }

        flowerDiv.appendChild(centerLink);

        // ğŸŒº å¤–åœˆèŠ±ç“£
        const step = (2 * Math.PI) / Math.max(n, 1);
        characters.forEach((c, i) => {
          const a = i * step - Math.PI / 2; // å¾ä¸Šæ–¹é–‹å§‹
          const x = Math.cos(a) * L.R;
          const y = Math.sin(a) * L.R;

          const { link, container } = createPetalElement(c, L.size);
          // ä½¿ç”¨ç›¸å°ä¸­å¿ƒé»çš„ä½ç§»
          container.style.transform = `translate(-50%,-50%) translate(${x}px,${y}px)`; 
          container.style.top = '50%'; container.style.left = '50%';
          link.style.position = 'absolute';

          // è®“ link ç›¸å°æ–¼ flowerDiv å®šä½
          link.style.transform = `translate(${x}px,${y}px)`;

          flowerDiv.appendChild(link);

          // âœ… éƒ¨é¦–åœˆï¼ˆæ­£å­—ã€ä¸è¨­ titleï¼‰
          if (c.radical) {
            const rx = Math.cos(a) * L.R2,
              ry = Math.sin(a) * L.R2;
            const dot = createRadicalDot(c);
            dot.style.transform = `translate(${rx}px,${ry}px) translate(-50%, -50%)`;
            flowerDiv.appendChild(dot);
          }
        });

        petalContainer.appendChild(flowerDiv);
      });
    }


    /**
     * æ ¹æ“šæ³¨éŸ³ç¬¦è™Ÿå¾ JSON æª”æ¡ˆè¼‰å…¥è³‡æ–™ã€‚
     * @param {string} zhuyin - è¦è¼‰å…¥çš„æ³¨éŸ³ç¬¦è™Ÿã€‚
     * @returns {Promise<Array<Object>>} - è³‡æ–™é™£åˆ—ã€‚
     */
    async function fetchData(zhuyin) {
      // *** èª¿æ•´è·¯å¾‘ï¼šå¾ data/ å–ç”¨æ³¨éŸ³ç¬¦è™Ÿæª”æ¡ˆ ***
      const filename = `data/${zhuyin}.json`; 
      loadingMessage.textContent = `æ­£åœ¨è¼‰å…¥ ${filename}...`;
      loadingMessage.classList.remove('page-hidden');
      
      const response = await fetch(filename);
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status} when fetching ${filename}`);
      }
      
      const data = await response.json();
      loadingMessage.classList.add('page-hidden');
      return data;
    }

    /**
     * å‰µå»ºæ³¨éŸ³ç¬¦è™ŸæŒ‰éˆ•ã€‚
     * @param {string} zhuyin - æ³¨éŸ³ç¬¦è™Ÿã€‚
     * @returns {HTMLElement} - æŒ‰éˆ•å…ƒç´ ã€‚
     */
    function createZhuyinButton(zhuyin) {
      const btn = document.createElement('button');
      btn.textContent = zhuyin;
      btn.className = 'w-10 h-10 flex items-center justify-center font-bold text-lg rounded-lg border shadow-sm transition-colors cursor-pointer bg-gray-100 text-gray-800 hover:bg-gray-200';
      // é€™è£¡ä½¿ç”¨ async å‡½å¼ä½œç‚º onclick handler
      btn.onclick = (e) => selectZhuyin(e.currentTarget, zhuyin);
      return btn;
    }

    /**
     * è™•ç†æ³¨éŸ³ç¬¦è™ŸæŒ‰éˆ•é»æ“Šäº‹ä»¶ï¼Œä¸¦è¼‰å…¥å°æ‡‰çš„è³‡æ–™ã€‚
     * @param {HTMLElement} btn - è¢«é»æ“Šçš„æŒ‰éˆ•å…ƒç´ ã€‚
     * @param {string} zhuyin - å°æ‡‰çš„æ³¨éŸ³ç¬¦è™Ÿã€‚
     */
    async function selectZhuyin(btn, zhuyin) {
      if (currentZhuyin === zhuyin) return; // é¿å…é‡è¤‡é»æ“Š

      // 1. è™•ç†æŒ‰éˆ•æ¨£å¼
      document.querySelectorAll('#zhuyin-container button').forEach(b => {
        b.classList.remove('btn-selected');
        b.classList.add('bg-gray-100', 'text-gray-800');
      });

      btn.classList.add('btn-selected');
      btn.classList.remove('bg-gray-100', 'text-gray-800');

      // 2. è¼‰å…¥è³‡æ–™
      currentZhuyin = zhuyin;
      petalContainer.innerHTML = ''; // æ¸…ç©ºèˆŠå…§å®¹
      
      try {
        const data = await fetchData(zhuyin);
        currentData = data;
        renderPetals(currentData);
      } catch (error) {
        console.error(`Failed to load data for ${zhuyin}:`, error);
        // éŒ¯èª¤è¨Šæ¯ä¸­é¡¯ç¤ºå®Œæ•´è·¯å¾‘
        const filePath = `data/${zhuyin}.json`;
        petalContainer.innerHTML = `<div class="p-8 text-red-600 text-center text-lg font-bold">è¼‰å…¥ ${filePath} è³‡æ–™å¤±æ•—ã€‚<br>è«‹æª¢æŸ¥æª”æ¡ˆè·¯å¾‘èˆ‡å…§å®¹æ˜¯å¦æ­£ç¢ºã€‚</div>`;
        loadingMessage.classList.add('page-hidden');
      }
    }

    /**
     * è¼‰å…¥åˆå§‹æ¸…å–® (manifest.json) ä¸¦è¨­å®šé è¨­ç•«é¢ã€‚
     */
    async function loadInitialData() {
      try {
        // 1. è¼‰å…¥ manifest.json
        // *** èª¿æ•´è·¯å¾‘ï¼šå¾ data/manifest.json å–ç”¨æ¸…å–®æª”æ¡ˆ ***
        const manifestPath = 'data/manifest.json';
        loadingMessage.textContent = `æ­£åœ¨è¼‰å…¥æ³¨éŸ³ç¬¦è™Ÿæ¸…å–® (${manifestPath})...`;
        const manifestResponse = await fetch(manifestPath);
        if (!manifestResponse.ok) {
          throw new Error(`Failed to load manifest.json from ${manifestPath}: ${manifestResponse.status}`);
        }
        const manifest = await manifestResponse.json();

        const symbols = manifest.symbols.map(s => s.zy);

        // 2. å»ºç«‹æ³¨éŸ³ç¬¦è™ŸæŒ‰éˆ•
        zhuyinContainer.innerHTML = ''; // æ¸…ç©ºã€Œæ­£åœ¨è¼‰å…¥...ã€
        if (symbols.length === 0) {
          zhuyinContainer.innerHTML = '<div class="text-red-600">manifest.json ä¸­æ²’æœ‰æ‰¾åˆ°æ³¨éŸ³ç¬¦è™Ÿæ¸…å–®ã€‚</div>';
          loadingMessage.classList.add('page-hidden');
          return;
        }

        symbols.forEach(zhuyin => {
          zhuyinContainer.appendChild(createZhuyinButton(zhuyin));
        });

        // 3. é¸å–ç¬¬ä¸€å€‹æ³¨éŸ³ç¬¦è™Ÿä½œç‚ºé è¨­é¡¯ç¤º
        const defaultZhuyin = symbols[0];
        const defaultBtn = zhuyinContainer.querySelector('button');

        if (defaultBtn) {
          // ç«‹å³è§¸ç™¼é¸å–ï¼Œè¼‰å…¥é è¨­è³‡æ–™ä¸¦æ¸²æŸ“
          await selectZhuyin(defaultBtn, defaultZhuyin);
        }

      } catch (error) {
        console.error('Initial data loading failed:', error);
        zhuyinContainer.innerHTML = `<div class="p-4 text-red-600">åˆå§‹åŒ–å¤±æ•—: ${error.message}</div>`;
        petalContainer.innerHTML = ''; // æ¸…ç©ºä¸»å€
        loadingMessage.classList.add('page-hidden');
      }
    }

    // æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•å…¥å£
    window.onload = loadInitialData;
  </script>
</body>
</html>
